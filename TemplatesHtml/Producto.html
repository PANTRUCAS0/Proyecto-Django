{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Productos | Tomy's Admin</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="{% static 'CssHtml/estilos_globales.css' %}">
    <link rel="stylesheet" href="{% static 'CssHtml/admin.css' %}">
</head>
<body class="admin-page">
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <h1>Gestión de Productos</h1>
        </div>
    </div>

    <div class="container">
        <!-- Botones superiores -->
        <div class="admin-button-group">
            <a href="{% url 'Admin' %}" class="btn-secondary-admin">
                <i class="bi bi-arrow-left-circle-fill"></i>
                Volver al Panel
            </a>
            <a href="{% url 'AgregarProducto' %}" class="btn-primary-admin">
                <i class="bi bi-plus-circle-fill"></i>
                Agregar Producto
            </a>
        </div>

        <!-- Grid de Productos -->
        {% if productos %}
            <div class="row g-4">
                {% for producto in productos %}
                <div class="col-12 col-md-6 col-lg-4" id="producto-{{ producto.id }}">
                    <div class="card h-100 shadow-sm producto-card">
                        <!-- Imagen -->
                        <div class="card-img-container" style="background: #F8F9FA; padding: 2rem; height: 250px; display: flex; align-items: center; justify-content: center;">
                            <img src="{{ producto.url_imagen }}" 
                                 alt="{{ producto.nombre }}"
                                 style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                        
                        <!-- Contenido -->
                        <div class="card-body">
                            <h5 class="card-title fw-bold">{{ producto.nombre }}</h5>
                            <p class="text-muted small mb-2">{{ producto.descripcion|truncatewords:10 }}</p>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-dark">Talla: {{ producto.talla|default:"—" }}</span>
                                <span class="badge" style="background: #FF6B35;">{{ producto.marca|default:"Sin marca" }}</span>
                            </div>
                            
                            <div class="text-center my-3">
                                <h3 class="text-primary mb-0" style="color: #FF6B35 !important; font-weight: 900;">
                                    ${{ producto.precio|floatformat:0 }}
                                </h3>
                            </div>
                            
                            <!-- Botones -->
                            <div class="d-grid gap-2">
                                <button class="btn-admin btn-admin-edit" 
                                        data-producto-id="{{ producto.id }}"
                                        data-nombre="{{ producto.nombre }}"
                                        data-descripcion="{{ producto.descripcion }}"
                                        data-precio="{{ producto.precio }}"
                                        data-imagen="{{ producto.url_imagen }}"
                                        data-talla="{{ producto.talla }}"
                                        data-marca="{{ producto.marca }}"
                                        onclick="abrirModalEditar(this)">
                                    <i class="bi bi-pencil-square"></i>
                                    Editar
                                </button>
                                <button class="btn-admin btn-admin-delete" 
                                        data-producto-id="{{ producto.id }}"
                                        onclick="eliminarProducto(this)">
                                    <i class="bi bi-trash3-fill"></i>
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="admin-table-container">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>No hay productos registrados</h3>
                    <p>Comienza agregando tu primer producto</p>
                    <a href="{% url 'AgregarProducto' %}" class="btn-primary-admin">
                        <i class="bi bi-plus-circle-fill"></i>
                        Agregar Primer Producto
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Modal para Editar -->
    <div class="modal fade" id="modalEditarProducto" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 20px; border: none; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #FF6B35, #FF8C61); color: white; border: none;">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-pencil-square me-2"></i>Editar Producto
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEditarProducto">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tag-fill text-primary me-2"></i>Nombre
                                </label>
                                <input type="text" class="form-control" id="editNombre" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-currency-dollar text-success me-2"></i>Precio
                                </label>
                                <input type="number" class="form-control" id="editPrecio" required>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-image-fill text-info me-2"></i>URL Imagen
                                </label>
                                <input type="url" class="form-control" id="editImagen" required>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-file-text-fill text-warning me-2"></i>Descripción
                                </label>
                                <textarea class="form-control" id="editDescripcion" rows="3" required></textarea>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-rulers text-secondary me-2"></i>Talla
                                </label>
                                <select class="form-select" id="editTalla">
                                    <option value="">Seleccione talla</option>
                                    <option value="38">38</option>
                                    <option value="39">39</option>
                                    <option value="40">40</option>
                                    <option value="41">41</option>
                                    <option value="42">42</option>
                                    <option value="43">43</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-award-fill text-danger me-2"></i>Marca
                                </label>
                                <select class="form-select" id="editMarca">
                                    <option value="">Seleccione marca</option>
                                    <option value="Nike">Nike</option>
                                    <option value="Adidas">Adidas</option>
                                    <option value="Puma">Puma</option>
                                    <option value="Yeezy">Yeezy</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCambios()" style="background: #FF6B35; border: none;">
                        <i class="bi bi-check-circle-fill me-2"></i>Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let productoActualId = null;
        let modalEditar = null;

        document.addEventListener('DOMContentLoaded', function() {
            modalEditar = new bootstrap.Modal(document.getElementById('modalEditarProducto'));
        });

        function abrirModalEditar(btn) {
            productoActualId = btn.getAttribute('data-producto-id');
            document.getElementById('editNombre').value = btn.getAttribute('data-nombre');
            document.getElementById('editDescripcion').value = btn.getAttribute('data-descripcion');
            document.getElementById('editPrecio').value = btn.getAttribute('data-precio');
            document.getElementById('editImagen').value = btn.getAttribute('data-imagen');
            document.getElementById('editTalla').value = btn.getAttribute('data-talla') || '';
            document.getElementById('editMarca').value = btn.getAttribute('data-marca') || '';
            
            modalEditar.show();
        }

        function guardarCambios() {
            const data = {
                nombre: document.getElementById('editNombre').value,
                descripcion: document.getElementById('editDescripcion').value,
                precio: parseFloat(document.getElementById('editPrecio').value),
                url_imagen: document.getElementById('editImagen').value,
                talla: document.getElementById('editTalla').value,
                marca: document.getElementById('editMarca').value
            };

            fetch(`/actualizar_producto/${productoActualId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    modalEditar.hide();
                    location.reload();
                } else {
                    alert('❌ Error al actualizar el producto');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error de red');
            });
        }

        function eliminarProducto(btn) {
            const productoId = btn.getAttribute('data-producto-id');
            
            if (!confirm("¿Estás seguro de eliminar este producto?")) return;

            fetch(`/eliminar-producto/${productoId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => {
                if (response.ok) {
                    const card = document.getElementById(`producto-${productoId}`);
                    card.style.animation = 'fadeOut 0.5s ease';
                    setTimeout(() => card.remove(), 500);
                } else {
                    alert('❌ Error al eliminar el producto');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error de red');
            });
        }
    </script>

    <style>
        .producto-card {
            transition: all 0.3s ease;
        }

        .producto-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(255, 107, 53, 0.2) !important;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
    </style>
</body>
</html>