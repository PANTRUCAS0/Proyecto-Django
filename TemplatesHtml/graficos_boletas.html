{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gráficos de Ventas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 30px;
        }
        .contenedor {
            width: 95%;
            margin: auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #283e51;
            margin-bottom: 40px;
        }

        /* Contenedor de los gráficos lado a lado */
        .graficos-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 40px;
        }

        .grafico-item {
            flex: 1 1 45%;
            min-width: 300px;
        }

        .grafico-item canvas {
            width: 100% !important;
            height: 450px !important;
        }

        .volver {
            text-align: center;
            margin-top: 40px;
        }
        .volver a {
            background: linear-gradient(135deg, #4b79a1, #283e51);
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: 0.3s;
        }
        .volver a:hover {
            opacity: 0.85;
        }
    </style>
</head>
<body>
<div class="contenedor">
    <h1>Gráficos de Ventas</h1>

    <div class="graficos-container">
        <div class="grafico-item">
            <canvas id="graficoBarras"></canvas>
        </div>
        <div class="grafico-item">
            <canvas id="graficoTorta"></canvas>
        </div>
    </div>

    <div class="volver">
        <a href="{% url 'detalle_boleta' %}">Volver al Panel</a>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);

document.addEventListener("DOMContentLoaded", () => {
    const detalles = JSON.parse('{{ detalles_json|escapejs }}');
    if (!detalles.length) return;

    // --- Gráfico de barras: por producto multicolor ---
    const productos = {};
    detalles.forEach(d => {
        if (!productos[d.nombre]) productos[d.nombre] = { cantidad: 0, subtotal: 0 };
        productos[d.nombre].cantidad += d.cantidad;
        productos[d.nombre].subtotal += d.subtotal;
    });

    const labelsProductos = Object.keys(productos);
    const cantidades = Object.values(productos).map(p => p.cantidad);

    const coloresBarras = [
        '#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF',
        '#FF9F40','#F67019','#45B39D','#D35400','#C0392B'
    ];
    const backgroundColors = labelsProductos.map((_, i) => coloresBarras[i % coloresBarras.length]);

    new Chart(document.getElementById('graficoBarras'), {
        type: 'bar',
        data: {
            labels: labelsProductos,
            datasets: [{
                label: 'Cantidad vendida',
                data: cantidades,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 2,
                hoverBackgroundColor: '#FFD700',
                hoverBorderColor: '#333',
                maxBarThickness: 50
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { 
                    display: true, 
                    text: 'Cantidad total vendida por producto',
                    font: { size: 18, weight: 'bold' }
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} unidades`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        autoSkip: true,
                        maxRotation: 45,
                        minRotation: 30
                    }
                },
                y: { beginAtZero: true }
            }
        }
    });

    // --- Gráfico de torta: por boleta con colores vivos ---
    const boletas = {};
    detalles.forEach(d => {
        const idBoleta = d.boleta_id;
        if (!boletas[idBoleta]) boletas[idBoleta] = 0;
        boletas[idBoleta] += d.subtotal;
    });

    let labelsBoletas = Object.keys(boletas);
    let subtotalesBoletas = Object.values(boletas);

    // Agrupar boletas <5% en "Otros"
    const total = subtotalesBoletas.reduce((a,b)=>a+b,0);
    const labelsFinal = [];
    const subtotalesFinal = [];
    let otros = 0;

    for (let i=0; i<labelsBoletas.length; i++) {
        if (subtotalesBoletas[i]/total < 0.05) {
            otros += subtotalesBoletas[i];
        } else {
            labelsFinal.push(labelsBoletas[i]);
            subtotalesFinal.push(subtotalesBoletas[i]);
        }
    }
    if (otros > 0) {
        labelsFinal.push('Otros');
        subtotalesFinal.push(otros);
    }

    const coloresTorta = [
        '#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF',
        '#FF9F40','#F67019','#45B39D','#D35400','#C0392B','#8E44AD','#1ABC9C'
    ];
    const backgroundColorsTorta = labelsFinal.map((_, i) => coloresTorta[i % coloresTorta.length]);

    new Chart(document.getElementById('graficoTorta'), {
        type: 'pie',
        data: {
            labels: labelsFinal,
            datasets: [{
                label: 'Subtotal por Boleta',
                data: subtotalesFinal,
                backgroundColor: backgroundColorsTorta
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Participación por Boleta (Subtotal)' },
                legend: {
                    display: true,
                    position: 'right',
                    labels: { boxWidth: 20, padding: 15 }
                },
                datalabels: {
                    formatter: (value, ctx) => {
                        const sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                        return ((value / sum) * 100).toFixed(1) + '%';
                    },
                    color: '#fff',
                    font: { weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            return `Subtotal: $${value.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
});
</script>
</body>
</html>
