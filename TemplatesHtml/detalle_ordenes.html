{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Órdenes | Tomy's Admin</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="{% static 'CssHtml/estilos_globales.css' %}">
    <link rel="stylesheet" href="{% static 'CssHtml/admin.css' %}">
</head>
<body class="admin-page">
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <h1>Detalle de Órdenes</h1>
        </div>
    </div>

    <div class="container">
        <!-- Botones superiores -->
        <div class="admin-button-group">
            <a href="{% url 'Admin' %}" class="btn-secondary-admin">
                <i class="bi bi-arrow-left-circle-fill"></i>
                Volver al Panel
            </a>
            <a href="{% url 'exportar_excel' %}" class="btn-primary-admin">
                <i class="bi bi-file-earmark-excel-fill"></i>
                Exportar a Excel
            </a>
            <a href="https://app.powerbi.com/view?r=eyJrIjoiNjg0MTBlMjYtNzA2Zi00NGUxLTg0MjctOWU4NTUzNWVjODI0IiwidCI6IjM4YTFlMGExLWI2YjEtNDJlOS1iM2E5LTU5NzYyNjY3MGIxNyIsImMiOjR9" 
               class="btn-primary-admin" target="_blank">
                <i class="bi bi-bar-chart-fill"></i>
                Ver Dashboard Power BI
            </a>
        </div>

        <!-- Buscador -->
        <div class="mb-4">
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" 
                       id="searchInput" 
                       class="form-control" 
                       placeholder="Buscar por ID, Producto o Marca...">
            </div>
        </div>

        <!-- Tabla -->
        {% if items %}
            <div class="admin-table-container">
                <div class="table-header">
                    <h2>Registro de Órdenes</h2>
                    <span class="badge">{{ items|length }} items</span>
                </div>
                
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nº ORDEN</th>
                                <th>PRODUCTO</th>
                                <th>DESCRIPCIÓN</th>
                                <th>TALLA</th>
                                <th>MARCA</th>
                                <th>PRECIO UNIT.</th>
                                <th>CANTIDAD</th>
                                <th>SUBTOTAL</th>
                                <th>TOTAL ORDEN</th>
                                <th>FECHA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr class="searchable-row">
                                <td><strong>#{{ item.orden.id }}</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ item.orden.numero_orden }}</span>
                                </td>
                                <td class="fw-bold">{{ item.producto_nombre }}</td>
                                <td class="text-muted">{{ item.producto_descripcion|truncatewords:5 }}</td>
                                <td>
                                    <span class="badge bg-dark">{{ item.talla|default:"—" }}</span>
                                </td>
                                <td>
                                    <span class="badge" style="background: #FF6B35;">{{ item.marca|default:"—" }}</span>
                                </td>
                                <td>${{ item.precio_unitario|floatformat:0 }}</td>
                                <td class="text-center">
                                    <strong>{{ item.cantidad }}</strong>
                                </td>
                                <td class="fw-bold">${{ item.subtotal|floatformat:0 }}</td>
                                <td class="text-success fw-bold">${{ item.orden.total|floatformat:0 }}</td>
                                <td>{{ item.orden.fecha_creacion|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="admin-table-container">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>No hay órdenes registradas</h3>
                    <p>Las órdenes de compra aparecerán aquí</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase().trim();
    const rows = document.querySelectorAll('.searchable-row');

    rows.forEach(row => {
        const id = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase().replace('#', '').trim() || "";
        const producto = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || "";
        const marca = row.querySelector('td:nth-child(6)')?.textContent.toLowerCase() || "";

        let match = false;

        // buscamos coincidencia exacta del ID
        if (!isNaN(filter) && filter !== "") {
            match = id === filter;
        } else {
            // busca coincidencias parciales en producto o marca
            match = producto.includes(filter) || marca.includes(filter);
        }

        row.style.display = match ? '' : 'none';
    });
});
</script>
</body>
</html>
