{% extends 'base.html' %}
{% load static %}

{% block title %}Inicio - Zapater√≠a Tomy‚Äôs{% endblock %}

{% block carousel %}
<!-- üîπ Carrusel de portada -->
<div id="carruselDestacado" class="carousel slide mb-4" data-bs-ride="carousel">
  <div class="carousel-inner">

    <div class="carousel-item active">
      <img src="{% static 'Fotos/ZapatillasYeezy.jpg' %}" class="d-block w-100" alt="Zapatilla 1" style="height: 480px; object-fit: cover;">
      <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
        <h5>Colecci√≥n Deportiva</h5>
        <p>Comodidad y estilo en cada paso üèÉ‚Äç‚ôÇÔ∏è</p>
      </div>
    </div>

    <div class="carousel-item">
      <img src="{% static 'Fotos/Zapatilla2.jpg' %}" class="d-block w-100" alt="Zapatilla 2" style="height: 480px; object-fit: cover;">
      <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
        <h5>Estilo Urbano</h5>
        <p>Descubre la nueva l√≠nea street üëü</p>
      </div>
    </div>

    <div class="carousel-item">
      <img src="{% static 'Fotos/ZapatillaLimitada.jpg' %}" class="d-block w-100" alt="Zapatilla 3" style="height: 480px; object-fit: cover;">
      <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
        <h5>Edici√≥n Limitada</h5>
        <p>Dise√±os √∫nicos para verdaderos coleccionistas üî•</p>
      </div>
    </div>
  </div>

  <button class="carousel-control-prev" type="button" data-bs-target="#carruselDestacado" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carruselDestacado" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
  </button>
</div>

{% endblock %}


{% block content %}
<!-- üîπ Barra de Filtros -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <form class="row gy-2 gx-3 align-items-end" method="GET" action="">

      <!-- Precio -->
      <div class="col-12 col-md-4">
        <label class="form-label fw-semibold">Rango de precio</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="number" class="form-control" name="min_precio" placeholder="M√≠nimo" value="{{ request.GET.min_precio }}">
          <span class="input-group-text">-</span>
          <input type="number" class="form-control" name="max_precio" placeholder="M√°ximo" value="{{ request.GET.max_precio }}">
        </div>
      </div>

      <!-- Talla -->
      <div class="col-6 col-md-3">
        <label class="form-label fw-semibold">Talla</label>
        <select name="talla" class="form-select">
          <option value="">Todas</option>
          {% for n in tallas %}
            <option value="{{ n }}" {% if request.GET.talla == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Marca -->
      <div class="col-6 col-md-3">
        <label class="form-label fw-semibold">Marca</label>
        <select name="marca" class="form-select">
          <option value="">Todas</option>
          {% for m in marcas %}
            <option value="{{ m }}" {% if request.GET.marca == m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Bot√≥n Filtrar -->
      <div class="col-12 col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- üîπ Secci√≥n de Productos -->
<section class="row g-4">
  {% for producto in productos %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card h-100 shadow-sm">
        <div class="card-img-container">
          <img src="{{ producto.url_imagen }}" class="card-img-top" alt="{{ producto.nombre }}">
        </div>
        <div class="card-body text-center">
          <h5 class="card-title">{{ producto.nombre }}</h5>
          <p class="text-muted small mb-2">{{ producto.descripcion }}</p>
          <p class="fw-bold text-success mb-3">${{ producto.precio }}</p>
          <button class="btn btn-outline-success btn-sm"
                  data-nombre="{{ producto.nombre }}"
                  data-descripcion="{{ producto.descripcion|escapejs }}"
                  data-precio="{{ producto.precio }}"
                  data-imagen="{{ producto.url_imagen }}"
                  onclick="agregarProductoDataset(this)">
            Agregar al carrito
          </button>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-warning text-center">
        No se encontraron productos con los filtros seleccionados.
      </div>
    </div>
  {% endfor %}
</section>



<!-- üîπ Chatbot Desplegable con Animaci√≥n -->
<div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
  <!-- Bot√≥n flotante -->
  <button id="chatbot-toggle" class="btn btn-primary rounded-circle shadow-lg"
          style="width: 60px; height: 60px; font-size: 24px;">
    üí¨
  </button>

  <!-- Caja del chatbot -->
  <div id="chatbot-box" class="border border-primary rounded shadow bg-white mt-2 p-3"
       style="width: 320px; display: none; opacity: 0; transform: translateY(20px); transition: all 0.3s ease;">
    <div class="d-flex justify-content-between align-items-center bg-primary text-white rounded-top p-2">
      <strong>ü§ñ Chat Thomy‚Äôs</strong>
      <button id="chatbot-close" class="btn btn-sm btn-light text-dark fw-bold" style="border-radius: 50%;">‚úñ</button>
    </div>

    <div id="chatbot-messages" style="height: 220px; overflow-y: auto; padding: 10px; font-size: 14px;"></div>

    <div class="input-group mt-2">
      <input type="text" id="chatbot-input" class="form-control" placeholder="Escribe tu duda...">
      <button id="chatbot-send" class="btn btn-primary">Enviar</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'JavaScript/Pagina.js' %}"></script>
<script>
// ‚úÖ Mostrar / ocultar chatbot con animaci√≥n
(function(){
  const toggleBtn = document.getElementById("chatbot-toggle");
  const closeBtn = document.getElementById("chatbot-close");
  const box = document.getElementById("chatbot-box");

  function toggleChat() {
    if (box.style.display === "none" || box.style.display === "") {
      box.style.display = "block";
      setTimeout(() => {
        box.style.opacity = "1";
        box.style.transform = "translateY(0)";
      }, 10);
    } else {
      box.style.opacity = "0";
      box.style.transform = "translateY(20px)";
      setTimeout(() => { box.style.display = "none"; }, 300);
    }
  }

  toggleBtn.addEventListener("click", toggleChat);
  closeBtn.addEventListener("click", toggleChat);
})();

// ‚úÖ L√≥gica del chatbot
(function(){
  const msgs = document.getElementById("chatbot-messages");
  const input = document.getElementById("chatbot-input");
  const sendBtn = document.getElementById("chatbot-send");

  function append(role, text) {
    const p = document.createElement("p");
    p.innerHTML = (role === "user" ? "<b>T√∫:</b> " : "<b>Bot:</b> ") + text;
    msgs.appendChild(p);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function enviar() {
    const pregunta = input.value.trim();
    if (!pregunta) return;
    append("user", pregunta);
    input.value = "";
    fetch("/chatbot/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pregunta })
    })
    .then(r => r.json())
    .then(d => append("bot", d.respuesta || "Sin respuesta."))
    .catch(() => append("bot", "Error de red."));
  }

  sendBtn.addEventListener("click", enviar);
  input.addEventListener("keydown", e => { if (e.key === "Enter") enviar(); });
})();
</script>
{% endblock %}
